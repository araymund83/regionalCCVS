# Load libraries ----------------------------------------------------------
library(pacman)
p_load(ggplot2, glue,tidyverse)

season <- 'breeding' #'nonbreeding'
country <- c('USA','CANADA', 'MEXICO')
years <- '2055'
group <- 'coastal' #'arctic' #'aridlands', 'arctic', 'boreal_forests', 'western_forests'



#load files
# dir <- glue('./outputs/{group}/')
# fls <-list.files (path = dir, pattern = 'df_prop',
#              full.names = T)
# tbls<- lapply(fls, read.csv)
# 
# # Applying the vulnerability function to each data frame in the list
# result_tbls <- lapply(seq_along(tbls), function(i) {
#   df <- tbls[[i]]
#   # Check for both column naming conventions
#   if ("colonization" %in% names(df) && "extirpation" %in% names(df)) {
#     df <- df %>%
#       rename(gain = colonization, loss = extirpation) %>%
#       mutate(CVb2 = round(2 + (loss / 0.2) - (gain / 0.4)))
#   } else if ("gain" %in% names(df) && "loss" %in% names(df) && "never" %in% names(df)) {
#     df <- df %>%
#       mutate(CVb2 = round(2 + (loss / 0.2) - (gain / 0.4)))
#     # Rename columns to match original convention
#     #names(df) <- c("X", "objID", "bcrID", "ID", "never", "gain", "loss", "stable", "species")
#   } else {
#     # Track species missing columns
#     message(glue("Species {fls[i]} is missing one or both column sets ('colonization', 'extirpation') or ('gain', 'loss', 'never')."))
#     df <- NULL
#   }
#   df
# })
# 
# 
# # Combine all tables into one
# combined_df <- bind_rows(result_tbls)
# combined_df$CVb2 <- ifelse(1.0 < combined_df$CVb2 & combined_df$CVb2 < 1.5, 2,
#   ifelse(combined_df$CVb2 < 1, 1,
#     ifelse(combined_df$CVb2 > 5, 5, combined_df$CVb2)))
# qs::qsave(combined_df, glue('./outputs/vulnerabilityTbl/vulTbl_{group}.qs'))
# data<- qs::qread(glue('./outputs/vulnerabilityTbl/vulTbl_{group}.qs'))
data<- qs::qread(glue('./outputs/vulnerabilityTbl/vulTbl_{group}.qs'))

# Create plot  ------------------------------------------------------------
# make a vector of colors
colors <- c('#0072B2', '#009E73', '#E69F00', '#D55E00', 'red')
#make the plot base
plot <-  ggplot() +
  #geom_abline(intercept = c(0.4, -0.1, -0.3, -0.5), slope = 1,  
   #           color = 'black') +
    geom_abline(intercept = 0.4, slope = 1, linewidth = 0.3, col = '#0072B2') +
    geom_abline(intercept = -0.1, slope = 1, linewidth = 0.3, col = '#009E73') +
    geom_abline(intercept = -0.3, slope = 1, linewidth = 0.3, col = '#E69F00') +
    geom_abline(intercept = -0.5, slope = 1, linewidth = 0.3, col = '#D55E00') +
 # geom_vline(xintercept = c(-0.1, -0.3, -0.5), linetype = 'solid', linewidth = 0.3, col = 'blue') +
  coord_cartesian(xlim = c(-0.1, 1.025), ylim = c(-0.05, 1.0)) +
  scale_x_continuous(breaks = seq(0, 1, 0.25), labels = c('0.0', '', '0.5', '', '1.0')) +
  scale_y_continuous(breaks = seq(0, 1.5, 0.25), labels = c('0.0', '', '0.5', '', '1.0', '', '1.5')) +
  xlab('\nProportion range loss') + ylab('Proportion range gain\n') +  
  ggtitle('Climate change vulnerability classifications\n',
          subtitle = str_to_title(glue('{group}'))) +
  theme_bw() + 
  theme(plot.title = element_text(size = 14, face = 'bold', hjust = 0.5), 
                     plot.subtitle = element_text(size = 14, face ='bold'),
                     text = element_text(size = 13, face = 'plain'), 
                     axis.title = element_text(size = 14, face = 'plain'), 
                     panel.grid.major = element_line(colour = 'grey90', size = 0.1), 
                     panel.grid.minor = element_blank(), 
                     strip.background = element_rect(fill = 'azure3'),
                     strip.text.x = element_text(size = 12, face = 'bold'))

# format data
vuln <- data %>% filter(!(gain == 0 & loss == 0 & never == 1) & 
                                 !is.na(gain) & !is.na(loss) & !is.na(never) &
                                 CVb2 != 'No' & bcrID != 100) 

# Filter out species using 
top20<-  vuln %>%
  group_by(bcrID) %>%
  filter(all(%pop_b >= 0.0))

# plot vulnerability across groups
 p <- plot + geom_point(data=result, aes(x=loss, y=gain, colour= factor(CVb2)), alpha=0.8, size=3) +
  scale_color_manual(values=colors, name='Vulnerability') +
   facet_wrap(~bcrID)

out_dir <- './figs'

ggsave(filename= glue('{out_dir}/bcr_vulnerability_acad_{group}.png'), p,
       height = 16, width = 20, dpi = 400)

# Split data by bcrID and create a list of plots
list_of_plots <- split(vuln, vuln$bcrID) %>%
  map(~ {
    plot +
      geom_point(data = ., aes(x = loss, y = gain, colour = factor(CVb2)), alpha = 0.8, size = 3) +
      scale_color_manual(values = c('#0072B2', '#009E73', '#E69F00', '#D55E00', 'green'), name = 'Vulnerability') +
      ggtitle(glue('Climate change vulnerability classifications\n {unique(.$group)}'))
  })
bcrs <- unique(vuln$bcrID)
# Save the plots
walk2(list_of_plots, names(list_of_plots), ~ {
  filename <- glue('{out_dir}/bcr_{.y}/bcr_vulnerability_{unique(.x$group)}.png')
  print(filename)
  ggsave(filename = filename, plot = .x, height = 16, width = 20, dpi = 400)
})

library(ggplot2)
library(dplyr)
library(glue)



# Split data by bcrID
split_data <- group_split(vuln, bcrID)

# Create and save individual plots for each bcrID
for (i in seq_along(split_data)) {
  # Extract data for the current bcrID
  current_data <- split_data[[i]]
  
  # Create a plot for the current bcrID
  current_plot <- plot +
    geom_point(data = current_data, aes(x = loss, y = gain, 
                                        colour = factor(CVb2)), 
               alpha = 0.8, size = 3) +
    scale_color_manual(values = c('#0072B2', '#009E73', '#E69F00', '#D55E00', 'green'), name = 'Vulnerability') +
    ggtitle(glue('Climate change vulnerability classifications\n {unique(current_data$group)}'))  # Use the appropriate column name
  
  # Save the plot
  current_out_dir <- glue('./figs/bcr_{unique(current_data$bcrID)}')  # Modify the path as needed
  ggsave(filename = glue('{current_out_dir}/bcr_vulnerability_{group}.png'), current_plot,
         height = 16, width = 20, dpi = 400)
}

